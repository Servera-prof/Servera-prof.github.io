<!-- A. CAPÇALERA I INITS (NO TOCAR) ============================== -->
<!DOCTYPE html>
<head>
    <title id="titol"></title>
    <link rel="icon" type="image/x-icon" href=../img/favicon.png>
    <meta charset="UTF-8">

    <style>
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type=number] {
      -moz-appearance: textfield;
    }

    pre{
        white-space: pre-wrap;
        overflow-wrap: break-word;
    }


    img[alt="c500"]{
        width: 500px;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    img[alt="fr350"]{
        width: 350px;
        float: right;
        margin: 0 0 0 0.7em;
    }

    li.preg {
        display: flex;
        align-items: flex-start;
        gap: 0.5em;
        text-align: justify;
        text-justify: inter-word;

    }
    p, li{
        text-align: justify;
        text-justify: inter-word;
    }
    </style>
</head>

<script>
window.texme = {
    renderOnLoad: false,
    markdownURL: '../js/marked/marked.min.js',
    MathJaxURL: '../js/mathjax/es5/tex-mml-chtml.js'
}
</script>
<script src="../js/texme/texme.js"></script>

<!-- FI NO TOCAR ================================================== -->




<!-- B. ENUNCIAT ================================================== -->
<textarea id="enunciat">
~~~
&nbsp;
    Permutació: [[p2]]
&nbsp;
~~~

## Preguntes

[[p1]]

## Resposta

[[i1]]



</textarea>
<!-- FI ENUNCIAT ================================================== -->







<!-- C. SCRIPT ==================================================== -->
<script>


// # 1. CONSTANTS (actualitzar) ---------------------------------------
const titol = "Test fet per alumnes";
const puntuacions = ["", 10];


// # 2. PARÀMETRES ====================================================

// ## 2.1. DECLARACIÓ (actualitzar) -----------------------------------

let p01 = "";
const preguntes = [
    [
    "Quin dos tipus de CT actualment ja no s'instalen i estan en per ser remplazats?",
    "Prefabricat i subterrani",
    "Subterrani i d'intempèrie",
    "Convencional d'obra i subterrani",
    "Convencional d'obra i d'intempèrie",
    ],
    [
    "Quan de passatapes té un transformador?",
    "4 de MT i 4 de BT",
    "3 de MT i de 4 de BT",
    "2 de MT i N, 2 de BT i N",
    "3 de MT i N, 3de BT i N",
    ],
    [
    "Quina afirmació sobre el transformdors de bany d'oli es certa?",
    "Les parets i sostre del CT han de ser resistents al foc",
    "Són més cars que els transformadors en sec",
    "L'oli no necesita canviarse mai",
    "Sempre duen dipòsit d'expansió",
    ],
    [
    "Quina protecció dels transformadors en bany d'oli el protegeix per complet?",
    "Relé Buchholz",
    "Vàlvula sobrepressió",
    "Termòstat",
    "Relé DGPT",
    ],
    [
    "Per a que serveix el punt deconveció?",
    "Per sabre només el tipus de bobinat del primari",
    "Per sabre la relació de transformació del bobinat secundari i primari",
    "Per sabre al polaritat del bobinat secunadari",
    "Per sabre el tipus de conexió del bobinat primari i secunadri",
    ],
    [
    "A quin grup de conexió és el Yz5?",
    "Triangle / zig-zag / 180º",
    "Estrella / zig-zag / 150º",
    "Zig-zag / triangle / 120º",
    "Estrella / Triangle / 150º",
    ],
    [
    "Quina condició es falsa per acoplar transformadors en paral·lel?",
    "Tensío de curtcircuit diferent",
    "Mateix desfasament(índex horari)",
    "Fases connectades de forma idèntica",
    "Mateixa relació de transformació",
    ],
    [
    "Quin és l’objectiu principal de la prova de corrent d’excitació en un transformador?",
    "Mesurar la temperatura del bobinat",
    "Detectar defectes com espires en curtcircuit",
    "Verificar el nivell d’oli del transformador",
    "Comprovar la resistència mecànica del nucli",
    ],
    [
    "Per què es fa la prova de resistència dels bobinats amb corrent continu (CC)?",
    "Per evitar danys en l’aïllament dels bobinats",
    "Perquè és l’única manera de mesurar la resistència amb precisió",
    "Per saturar el nucli i obtenir una lectura estable",
    "Per reduir les pèrdues per corrents parasitaries",
    ],
    [
    "Quina és l'objectiu principal de la prova de resistència d’aïllament en un transformador?",
    "Verificar la qualitat de l’oli dielèctric",
    "Mesurar la resistència al pas de corrent entre elements a diferent potencial",
    "Comprovar la resistència mecànica del nucli del transformador",
    "Determinar la tensió màxima que pot suportar el transformador",
    ],
    [
    "Quina informació trobem en la placa de característiques d’un transformador?",
    "Nom del fabricant i any de fabricació",
    "Tipus de refrigeració, potència nominal i tensions de funcionament",
    "La quantitat d’oli que s’ha de canviar anualment",
    "La velocitat màxima de funcionament",
    ],
    [
    "Què significa la codificació ONAN en un transformador?",
    "Circulació de l’oli i de l’aire per convecció natural",
    "Refrigeració amb oli i ventiladors forçats",
    "Circulació forçada de l’oli i de l’aire amb bombes",
    "Refrigeració sense oli, només amb aire",
    ],
    [
    "Quina funció té un fusible en un sistema de mitjana tensió?",
    "Protegir contra curtcircuits i grans sobrecàrregues",
    "Permetre el pas de la tensió només en condicions normals",
    "Tallar el circuit automàticament quan hi ha una baixa tensió",
    "Reduir la tensió de línia per protegir els components interns",
    ],
    [
    "Quina és la funció principal d’una cel·la de línia en un centre de transformació?",
    "Protegir el transformador amb fusibles de seguretat",
    "Connectar i desconnectar el centre de transformació de l’alimentació en MT",
    "Controlar la temperatura del transformador",
    "Reduir el soroll elèctric a l’interior del centre de transformació",
    ],
    [
    "Per què el neutre no porta fusible en un quadre de baixa tensió?",
    "Perquè el neutre no pot portar corrent en cap situació",
    "Perquè si es talla el neutre es poden generar tensions perilloses en les fases",
    "Perquè no existeixen fusibles dissenyats per al neutre",
    "Perquè el neutre només es desconnecta en casos de sobrecàrrega extrema",
    ],



];

let permutacio = "";
const num_preg = preguntes.length;
const num_resp = preguntes[0].length-1;
const fact_np = factorial(num_preg);
const fact_nr = factorial(num_resp);
/*let ordre_preg = Math.floor(aleat(0, fact_np - 1)/1e16)*/;
let ordre_preg = aleat(0, fact_np - 1);

console.log(ordre_preg)
permutacio += ordre_preg + "_";
//ordre_preg *= 1e16;

const preg_ordenades = obtenirPermutacio(preguntes, ordre_preg);

for (let i = 0; i < num_preg; i++){
    p01 += '<p><b>' + (i+1) + '.</b> ' + preg_ordenades[i][0] + '</p>';
    let ordre_resp = aleat (0, fact_nr - 1);
    permutacio += ordre_resp + ".";

    let resp = obtenirPermutacio(preg_ordenades[i].slice(1), ordre_resp);
    p01 += '<ol style="list-style-type: none;">'
    for (let j = 0; j < num_resp; j++){
        p01 += '<li class="preg"><span><i>' + nombreALletra(j+1) +
               '</i>) </span><span style="flex: 1;">' +
               resp[j] + "</span></li>"
    }
    p01 += "</ol>"
}

p02 = permutacio;





// ## 2.2 FUNCIO (actualitzar) ----------------------------------------
// !!! CONVERTIR si és necessari les unitats a les unitats que requereix
// el nostre enunciat.

function estableixParametres(){
    array = [
      p01, p02
    ];
    parametres = parametres.concat(array);  // no tocar aquesta línia
}




// # 3. CALCULS =======================================================

// ## 3.1 CALCUL VALORS (ACTUALITZAR) ---------------------------------
function calcula(){

}





// # D. ENTRENADOR SERVERI ============================================


// # 1. VARIABLES GLOBALS =============================================

let txtEnunciat = "";   // l'enunciat de l'apartat B.
let parametres = [""];  // els paràmetres del punt 3.1.
let solucions = [""];   // els valors que ha donat el programa.
let respostes = [""];   // els valors que ha donat l'alumne.
let alumne = {
    nom: "",
    cicle: "CFGS Técnic Superior en sistemes electrotècnics i automatitzats",
    anys: "2024/2025"
}
let tlog = "";          // log que apareix al final de l'avaluació.



// # 2. FUNCIONS ======================================================




window.onload = function (){
    // txtEnunciat és una variable global
    txtEnunciat = document.getElementById("enunciat").value;
    renderEnunciat(txtEnunciat);
}

function renderEnunciat(){
    let txt = "";
    estableixParametres(); // Va al punt 3.2. de l'apartat C. (script)
    txt = '<h1 align ="center">' + titol + "</h1>\n&nbsp;\n\n" +
          txtEnunciat;
    txt = exportarParametres(txt);
    txt = crearInputs(txt);
    txt = crearIdentificacio(txt);
    document.getElementById("enunciat").innerHTML = txt;
    document.getElementById("titol").innerText = titol;
    texme.renderPage();
}

function exportarParametres(txt){
    let patro = "", canvi = "";
    const fi = parametres.length;
    for (let i = 1; i < parametres.length; i++) {
        patro = "[[p" + i +"]]";
        canvi = parametres[i];
        txt = txt.replace(patro, canvi);
    }
    return txt;
}

function crearInputs(txt){
    let patro = "", canvi = "";
    for (let i = 1; i < puntuacions.length; i++) {
        patro = "[[i" + i +"]]";
        canvi = '<input type="text" onwheel="return false;" ';
        canvi += 'id="i'+ i +'" style="width: 300px">';
        txt = txt.replace(patro, canvi);
    }
    return txt;
}

function crearIdentificacio(txt){
txt += `
<h2>Identificació de l'alumne</h2>

<form id="avalua" onsubmit="event.preventDefault() & avalua()">
    <label>Nom de l'alumne: </label>
    <input id="nom" style="width: 400px"/>
    <div>
        <input type="checkbox" id="informat" required/>
        <label>
            Entenc que al premer el botó avaluar no es pot tornar
            enrera.
        </label>
    </div>
    <br/>
    <div style="text-align: center;">
        <button type="submit" id="boto"
            style="font-size: 20px; color: #AA5050;">
            Avaluar
        </button>
    </div>
</form>
`; return txt;
}

function avalua(){
    importaRespostes();
    resetejar();
    renderAvaluacio();
}

function importaRespostes(){
    respostes[0] = document.getElementById("i1").value
    alumne.nom = document.getElementById("nom").value;
}

function resetejar(){
    const ppal = document.getElementsByTagName("main")[0];
    const body = ppal.parentNode;
    const textArea = body.appendChild(document.createElement("textarea"));
    body.removeChild(ppal);
    textArea.setAttribute("id", "avaluacio");
}

function renderAvaluacio(){
    let txt = "";
    txt += '<h1 align="center"> Avaluació</h1>\n' +
           '<h2 align="center" style="color: #888">' + titol +
           "</h2>\n&nbsp;\n\n"
    txt += [
    "## Presentació de resultats",
    "",
    "L'alumne **[[nom]]**, del [[cicle]] (any [[any]]) serà qualificat manualment.",
    "",
    ].join("\n") + "\n";
    txt += txtEnunciat;

    txt = identificarAlumne(txt);
    txt = puntua(txt);
    txt = txt.replace("## Identificació de l'alumne:\n\n"+
        "[[identificacio]]", "");
    txt +=  "\n" + tlog + "\n";
    document.getElementById("avaluacio").innerHTML = txt;
    texme.renderPage();
}

function identificarAlumne(txt){
    txt = txt.replace("[[nom]]", alumne.nom);
    txt = txt.replace("[[cicle]]", alumne.cicle);
    txt = txt.replace("[[any]]", alumne.anys);
    return txt;
}

function puntua(txt){
    calcula();

    txt = exportarParametres(txt);

    patro = "[[i1]]";
    canvi = "~~~\n    " + respostes[0] + "\n\n\n~~~";

    txt = txt.replace(patro, canvi);

    return txt;
}












function aleat(min, max) { // enter aleat entre min i max (inclosos)
    const a = Math.ceil(min);
    const b = Math.floor(max);
    const c = Math.floor(Math.random() * (b - a + 1) + a);
    return c;
}

function triaElementMatriu (matriu){
    const aleat = Math.floor(Math.random() * (matriu.length));
    return matriu[aleat.toFixed(0)];
}

function factorial(n) {
    return n <= 1 ? 1 : n * factorial(n - 1);
}

// Funció per obtenir la permutació d'un índex específic
function obtenirPermutacio(array, index) {
    let permutacio = [];
    let elements = array.slice(); // Copia de l'array per a evitar
                                  // modificar l'original
    let n = elements.length;

    // Calcular la permutació utilitzant factorials
    for (let i = 0; i < n; i++) {
        let fact = factorial(n - i - 1);
        let posicio = Math.floor(index / fact);
        permutacio.push(elements[posicio]);
        elements.splice(posicio, 1);
        index %= fact;
    }

    return permutacio;
}

function permutacions(array) {

    let resultat = [];

    // Funció recursiva per a generar les permutacions
    function generarPermutacions(actual, resta) {
        if (resta.length === 0) {
            resultat.push(actual);
        } else {
            for (let i = 0; i < resta.length; i++) {
                let actualNova = actual.concat(resta[i]);
                let restaNova = resta.slice(0, i).concat(resta.slice(i + 1));
                generarPermutacions(actualNova, restaNova);
            }
        }
    }

    generarPermutacions([], array);
    return resultat;
}


function nombreALletra(nombre) {
    const ascii = 97; // Código ASCII de 'a'
    if (nombre >= 1 && nombre <= 26) {
        // Convertir el número en el carácter correspondiente usando el código ASCII
        return String.fromCharCode(ascii + nombre - 1);
    } else {
        return null; // Retornar null si el número está fuera de rango
    }
}

</script>














<!--
/**********************************************************************
 * - Establir les puntuacions, que han de correspondre amb la quantitat
 * de respostes que l'alumne pot contestar.
 *
 * - Establir els paràmetres. En general serà una funció per a generar
 * nombres aleatoris, però també es poden fixar. Aquest últim cas és
 * interessant per a testejar els càlculs. IMPORTANT: Al finalitzar
 * tots els parametres hauran de concatenarse al vector parametres.
 *
 * -  El mateix succeeix amb els càlculs. Tot haura de volcar-se al
 * vector solucions.
 * *******************************************************************/
-->
