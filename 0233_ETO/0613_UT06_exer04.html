<!-- A. CAPÇALERA I INITS (NO TOCAR) ============================== -->
<!DOCTYPE html>
<head>
    <title id="titol"></title>
    <link rel="icon" type="image/x-icon" href=img/favicon.png>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/main.css" />
</head>
<textarea id="enunciat">

Comprova la següent imatge:

> <canvas id="c1" width="450" height="300" style="border:3px solid grey; display:block; margin:auto"></canvas>

Quina és la freqüència de resonància?

[[i1]] Hz

</textarea>
<!-- FI ENUNCIAT ================================================== -->







<!-- C. SCRIPT TEXME================================================ -->
<script>
window.texme = {
    renderOnLoad: false,
    style: 'none',
    markdownURL: 'js/marked/marked.min.js',
    MathJaxURL: 'js/mathjax/es5/tex-mml-chtml.js'
}
</script>

<script src="js/texme/texme.js"></script>


<script>
// # 1. CONSTANTS (actualitzar) ---------------------------------------
const titol = "Filtre pasa banda - Exercici 04";
const puntuacions = ["", 1];
const π = 3.141592654;



// # 2. PARÀMETRES ====================================================

const c_μF = aleat(1, 9999)/100;
const l_mH = aleat(1, 9999)/10;


// # 3. VARIABLES GLOBALS =============================================

let canvas;
let ctx;                            // context
let color;
let gruix;


// ## 2.2 FUNCIO (actualitzar) ----------------------------------------
function estableixParametres(){
    p = [];
    parametres = parametres.concat(p);
}

function dibuixaCanvas(){
    init();
        
    font_ac([50, 100], "h", "10 V", "??? Hz");
    res([75, 50], "h", "R1", "250 Ω");
    cond([200, 100], "v", "C1", l(c_μF) + " μF");
    induc([350, 100], "v", "L1", l(l_mH) + " mH");
    pl([50, 100, 50,50, 75,50]);
    pl([175, 50, 275, 50, 275, 100]);
    pl([200, 100, 350, 100]);
    pl([200, 200, 350, 200]);
    pl([275, 200, 275, 250, 50, 250, 50, 200]);  
}

function init(){
    canvas = document.getElementById("c1");
    ctx = canvas.getContext("2d");
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "black";
    color = "black";
    color2 = "white"
    tancat = false;
    omple = false;
    vores = true;
    gruix = 1;
    lim_elem = false;
    graella = false;
    if (graella) dibuixa_graella();
}

function res (pto, β, txt_1, txt_2){
    const x = pto[0];
    const y = pto[1];    
    pl([x, y, x+20, y]);
    rect([x+20, y-8, x+80, y+8]);
    pl([x+80, y, x+100, y]);    
    text(txt_1, [x+25, y-15], "10px mono");
    text(txt_2, [x+25, y+25], "10px mono");
    if (lim_elem) rect([x, y-50, x+100, y+50]);
}

function font_ac(pto, β, txt_1, txt_2){
    const x = pto[0];
    const y = pto[1];
    pl([x, y, x, y+20]);
    circ(30, [x, y+50]);
    pl([x, y+80, x, y+100]);     
    text("∿", [x-13, y+60], "40px sans");    
    text(txt_1,  [x+40, y+48], "10px mono"); 
    text(txt_2, [x+40, y+62], "10px mono");    
    if (lim_elem) rect([x-50, y, x+100, y+100]);
}

function cond(pto, β, txt_1, txt_2){
    const x = pto[0];
    const y = pto[1];    
    pl([x, y, x, y+45]);
    pl([x-20, y+45, x+20, y+45]);
    pl([x-20, y+55, x+20, y+55]);
    pl([x, y+55, x, y+100]);
    text(txt_1, [x+30, y+48], "10px mono");
    text(txt_2, [x+30, y+62], "10px mono");
    if (lim_elem) rect([x-50, y, x+100, y+100]);
    
}

function induc(pto, β, txt_1, txt_2){
    const x = pto[0];
    const y = pto[1];    
    pl([x, y, x, y+29]);
    arc(7, [x, y+36], -90, 90);
    arc(7, [x, y+50], -90, 90);
    arc(7, [x, y+64], -90, 90);
    pl([x, y+71, x, y+100]);    
    text(txt_1, [x+17, y+48], "10px mono");
    text(txt_2, [x+17, y+62], "10px mono");
    if (lim_elem) rect([x-50, y, x+100, y+100]);
}   

function dibuixa_graella(){
    color = "whitesmoke";
    for (let i = 0; i <= 500; i+=10){
        pl([i, 0, i, 500]);
        pl([0, i, 500, i]);
    }
    color = "lightgrey";
    for (let i = 0; i <= 500; i+=50){
        pl([i, 0, i, 500]);
        pl([0, i, 500, i]);
    }
    color = "grey";
    for (let i = 0; i <= 500; i+=100){
        text(i, [i+2, 12], "10px mono");
        text(i, [2, i+12], "10px mono");
    }
    gruix = 2;
    for (let i = 0; i <= 500; i+=100){
        pl([i, 0, i, 5]);
        pl([0, i, 5, i]);

    }
    gruix=1
    color = "black";
}
    
function pl (vector){
    ctx.beginPath();
    ctx.moveTo(vector[0]+0.5, vector[1]+0.5);

    for (let i = 1; i < (vector.length/2); i++) {
        const x = vector[i*2]+0.5;
        const y = vector[i*2+1]+0.5;
        ctx.lineTo(x, y);
    }
    if (tancat) ctx.closePath();
    ctx.strokeStyle = color;
    ctx.fillStyle = color2;
    ctx.lineWidth = gruix;
    if (vores) ctx.stroke();
    if (omple) ctx.fill();
}

function arc (radi, centre, θi, θf){
    const r = radi;
    const cx = centre[0];
    const cy = centre[1];
    const θ1 = θi/360*2*π;
    const θ2 = θf/360*2*π;
    
    ctx.beginPath();
    ctx.arc(cx, cy, r, θ1, θ2);
    ctx.strokeStyle = color;
    ctx.stroke();
} 

function rect (diagonal){
    const x1= diagonal[0] + 0.5;
    const y1 = diagonal[1] + 0.5;
    const x2 = diagonal[2] + 0.5;
    const y2 = diagonal[3] + 0.5;
    const a = x2-x1;
    const h = y2-y1;
    
    ctx.beginPath();
    ctx.rect(x1, y1, a, h);
    ctx.strokeStyle = color;
    ctx.fillStyle = color2;
    if (vores) ctx.stroke();
    if (omple) ctx.fill();
}



function circ (radi, centre){
    
    const r = radi;
    const cx = centre[0];
    const cy = centre[1];
    ctx.beginPath();
    
    ctx.arc(cx, cy, r, 0, 2*π);
    ctx.strokeStyle = color;
    ctx.fillStyle = color2;
    ctx.lineWidth = gruix;
    if (vores) ctx.stroke();
    if (omple) ctx.fill();
}

function text (s, pto, tfont=font){
    const x = pto[0];
    const y = pto[1];
    
    ctx.fillStyle = color;
    ctx.font = tfont;
    ctx.fillText(s, x, y);
}



// # 3. CALCULS =======================================================

// ## 3.1 CALCUL VALORS (ACTUALITZAR) ---------------------------------
function calcula(){

let fr = 1/(2*π*(l_mH*1e-3*c_μF*1e-6)**0.5);

s01 = fr;


solucions = [""].concat([
    s01
]);


// ## 3.2 LOG ---------------------------------------------------------

}







/* *********************************************************************
 *                                                                     *
 *                    ~~~~ ENTRENADOR SERVERI ~~~~                     *
 *                                                                     *
 ******************************************************************** */
// # 1. VARIABLES GLOBALS =============================================

let txtEnunciat = "";   // l'enunciat de l'apartat B.
let parametres = [""];  // els paràmetres del punt 3.1.
let solucions = [""];   // els valors que ha donat el programa.
let respostes = [""];   // els valors que ha donat l'alumne.
let alumne = {
    nom: "",
    cicle: "CFGM Tècnic en instal·lacions elèctriques i automàtiques",
    anys: "2024/2025"
}
let ptsTotal = 0;
let ptsAlumne = 0;
let tlog = "";          // log que apareix al final de l'avaluació.



// # 2. FUNCIONS ======================================================

window.onload = function (){
    txtEnunciat = document.getElementById("enunciat").value;
    renderEnunciat(txtEnunciat);
}

function renderEnunciat(){
    let txt = "";
    estableixParametres();
    txt = '<h1 align ="center">' + titol + "</h1>\n&nbsp;\n\n" +
          txtEnunciat;
    txt = exportarParametres(txt);
    txt = crearInputs(txt);
    txt = crearIdentificacio(txt);
    document.getElementById("enunciat").innerHTML = txt;
    document.getElementById("titol").innerText = titol;
    texme.renderPage();
    dibuixaCanvas();
}

function exportarParametres(txt){
    let patro = "", canvi = "";
    const fi = parametres.length;
    for (let i = 1; i < parametres.length; i++) {
        patro = "[[p" + i +"]]";
        canvi = parametres[i];
        txt = txt.replace(patro, canvi);
    }
    return txt;
}

function crearInputs(txt){
    let patro = "", canvi = "";
    for (let i = 1; i < puntuacions.length; i++) {
        patro = "[[i" + i +"]]";
        canvi = '<input type="number" onwheel="return false;" ';
        canvi += 'id="i'+ i +'" style="width: 80px">';
        txt = txt.replace(patro, canvi);
    }
    for (let i = 1; i < puntuacions.length; i++) {
        patro = "[[itxt" + i +"]]";
        canvi = '<input type="text" ';
        canvi += 'id="itxt'+ i +'" style="width: 200px">';
        txt = txt.replace(patro, canvi);
    }
    return txt;
}

function crearIdentificacio(txt){
txt += `
<h2>Identificació de l'alumne</h2>

<form id="avalua" onsubmit="event.preventDefault() & avalua()">
    <label>Nom de l'alumne: </label>
    <input id="nom" style="width: 400px"/>
    <div>
        <input type="checkbox" id="informat" required/>
        <label>
            Entenc que al premer el botó avaluar no es pot tornar
            enrera.
        </label>
    </div>
    <br/>
    <div style="text-align: center;">
        <button type="submit" id="boto"
            style="font-size: 20px; color: #AA5050;">
            Avaluar
        </button>
    </div>
</form>
`; return txt;
}

function avalua(){
    importaRespostes();
    resetejar();
    renderAvaluacio();
}

function importaRespostes(){
    let r = [""];
    alumne.nom = document.getElementById("nom").value;
    for (let i = 1; i < puntuacions.length; i++){
        a = document.getElementById("i"+i);
        b = document.getElementById("itxt"+i);
        if (a != null){
          r[i] = xs(a.value);
        } else{
          r[i] = b.value;
        }
    }
    respostes = r.slice(); 
}

function resetejar(){
    const ppal = document.getElementsByTagName("main")[0];
    const body = ppal.parentNode;
    const textArea = body.appendChild(document.createElement("textarea"));
    body.removeChild(ppal);
    textArea.setAttribute("id", "avaluacio");
}

function renderAvaluacio(){
    let txt = "";
    txt += '<h1 align="center"> Avaluació</h1>\n' +
           '<h2 align="center" style="color: #888">' + titol + "</h2>\n&nbsp;\n\n"
    txt += [
    "## Presentació de resultats",
    "",
    "L'alumne **[[nom]]**, del [[cicle]] (any [[any]]) ha obtingut una",
    "qualificació de:",
    "",
    "> [[nota]]"
    ].join("\n") + "\n";
    txt += "## Enunciat\n\n" + txtEnunciat;

    txt = identificarAlumne(txt);
    txt = puntua(txt);
    txt = txt.replace("## Identificació de l'alumne:\n\n"+
        "[[identificacio]]", "");
    txt +=  "\n" + tlog + "\n";
    document.getElementById("avaluacio").innerHTML = txt;
    texme.renderPage();
    dibuixaCanvas();
}

function identificarAlumne(txt){
    txt = txt.replace("[[nom]]", alumne.nom);
    txt = txt.replace("[[cicle]]", alumne.cicle);
    txt = txt.replace("[[any]]", alumne.anys);
    return txt;
}

function puntua(txt){
    calcula();

    txt = exportarParametres(txt);

    let pts = 0;
    let canvi = "", patro = "", resp = "", solu = "";
    let acceptada = false;
    for (let i = 1; i < puntuacions.length; i++){
        pts = puntuacions [i];
        resp = respostes[i];
        solu = solucions[i];
        ptsTotal += puntuacions[i];
        
        patro = "[[i" + i + "]]";
        if (txt.includes(patro)){
            canvi = fnum (resp, solu, pts);
            txt = txt.replace(patro, canvi);
        }
        
        patro = "[[itxt" + i + "]]";
        if (txt.includes(patro)){
            canvi = ftxt (resp, solu, pts);
            txt = txt.replace(patro, canvi);
        }
        
    }
    txt = txt.replace("[[nota]]", "S'han aconseguit: "+ xs(ptsAlumne, 2) +
        " punts de " + xs(ptsTotal, 2) + " possibles.\n>\n>" +
        "**Nota final: " + xs(ptsAlumne/ptsTotal*10, 2) + "**");
    return txt;
}

function fnum (resp, solu, pts){     // formata una resposta i solució numèrica
    if (!isNaN(solu)){
        acceptada = (solu*0.99) <= resp && resp <= (solu*1.01);
    } else{
        return "ERROR";
    }
    
    canvi =
    '<span style="border-bottom: 1px solid silver; padding: 0.2em 1em 0;">' +
        coma(resp) + '</span>';
    if (acceptada) {
        ptsAlumne += pts;
        canvi +=
            ' <span style="color: green">(' + l(solu) + ') OK (+' + pts + 
            ')</span>';
    }else{
        canvi +=
            ' <span style="color: red;"> (' + l(solu) + ')</span>';
    }
    return canvi;
}

function ftxt (resp, solu, pts){          // formata una resposta i solució de texte
    acceptada = (resp == solu);
    
    canvi =
    '<span style="border-bottom: 1px solid silver; padding: 0.2em 1em 0;">' +
        "" + resp + '</span>';
    if (acceptada) {
        ptsAlumne += pts;
        canvi +=
            ' <span style="color: green">(' + "" + solu + ') OK (+' + 
            pts + ')</span>';
    }else{
        canvi +=
            ' <span style="color: red;"> (' + "" + solu + ')</span>';
    }
    return canvi;
}












function aleat(min, max) { // enter aleat entre min i max (inclosos)
    const a = Math.ceil(min);
    const b = Math.floor(max);
    const c = Math.floor(Math.random() * (b - a + 1) + a);
    return c;
}

function triaElementMatriu (matriu){
    const aleat = Math.floor(Math.random() * (matriu.length));
    return matriu[aleat.toFixed(0)];
}

function tan(a){
    return Math.tan(a*2*π/360);
}

function atan(a){
    return Math.atan(a)*360/2/π;
}

function sin(a){
    return Math.sin(a*2*π/360);
}

function asin(a){
    return Math.asin(a)*360/2/π;
}

function cos(a){
    return Math.cos(a*2*π/360);
}

function acos(a){
    return Math.acos(a)*360/2/π;
}


function cbi(x, y){ //complexe input en binomial
    const c = {};
    c.r = (x**2 + y**2)**0.5;
    c.φ = Math.atan2(y, x)*360/2/π;
    c.x = x;
    c.y = y;
    return c;
}

function cpol(r, φ){ //complexe input en polar
    const c = {};
    c.r = r;
    c.φ = φ;
    c.x = r * cos(φ);
    c.y = r * sin(φ);
    return c;
}

function sumc(a, b){
    return cbi(a.x + b.x, a.y + b.y)
}

function restc(a, b){
    return cbi(a.x - b.x, a.y - b.y)
}

function multc(a, b){
    return cpol(a.r*b.r, a.φ+b.φ);
}

function multc_esc(λ, a){
    return cpol(λ*a.r, a.φ);
}

function divc(a, b){
    return cpol(a.r/b.r, a.φ-b.φ);
}

function invc(a){ // inversa d'un complexe
    return cpol(1/a.r, -a.φ);
}

function logc (nom, v){ // log de un numero complexe
    let log = "";
    log += nom + ": ";
    log += xs(v.x);
    if (v.y > 0) log += " + j" + xs(v.y);
    else if (v.y < 0) log += "-j" + xs(-v.y);
    log += "; ";
    log += xs(v.r) + "∠" + xs(v.φ) + "°\n";
    log = coma(log);
    return log;
}

function logcbi (v){ // log de un numero complexe només en binomial
    let log = "";
    log += xs(v.x);
    if (v.y > 0) log += " + j" + xs(v.y);
    else if (v.y < 0) log += "-j" + xs(-v.y);
    log = coma(log);
    return log;
}

function l(a, b = 4){  // log abreviat a l totsol
    return coma(xs(a, b));
}

function ll(a, b = 4){ // log Latex
    return cl(xs(a, b));
}

function xs(a, b = 4){
    a = Number(a);
    if (a.toPrecision) a = a.toPrecision(b);
    return a;
}

function coma(a){
    a = a + "";
    return a.replaceAll(".", ",");
}

function cl(a){ // coma per a latex
    return coma(a).replaceAll(",", "{,}");
}

function xsMap(a){
    a = xs(a);
    return a;
}

function binari(n) {
    a = n;
    return a.toString(2).toString();
}

function hexadecimal(n) {
    a = n;
    return a.toString(16).toUpperCase();
}


</script>
